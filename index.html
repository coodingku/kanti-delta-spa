<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kantin Delta Spa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS UNTUK TAMPILAN CETAK PDF */
        @media print {
            nav, .no-print, button, .filter-area { display: none !important; }
            body { background: white; padding: 0; }
            .print-container { width: 100%; border: none; box-shadow: none; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000 !important; padding: 10px; text-align: left; color: black; }
            .report-header { display: block !important; text-align: center; margin-bottom: 20px; }
        }
        .report-header { display: none; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-blue-700 text-white p-4 shadow-md no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold uppercase tracking-tight">Kantin Delta Spa</h1>
            <div class="flex gap-4">
                <button onclick="window.location.reload()" class="text-sm hover:text-blue-200">Refresh</button>
                <button onclick="bukaAdmin()" class="bg-blue-800 px-4 py-1 rounded-full text-sm">Admin</button>
            </div>
        </div>
    </nav>

    <div id="section-scan" class="container mx-auto mt-12 p-4 no-print">
        <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100 text-center">
            <h2 class="text-gray-500 font-bold text-xs uppercase mb-2">Silahkan Scan Kartu</h2>
            <input type="text" id="input-nik" class="w-full p-4 border-2 border-blue-600 rounded-xl text-center text-2xl font-bold focus:outline-none focus:ring-4 focus:ring-blue-100" placeholder="INPUT NIK..." autofocus>
            <div id="pesan-status" class="mt-6 p-4 rounded-xl font-bold hidden"></div>
        </div>
    </div>

    <div id="section-admin" class="container mx-auto mt-8 p-4 hidden">
        <div class="flex flex-col md:flex-row gap-6">
            
            <aside class="w-full md:w-64 space-y-2 no-print">
                <button onclick="tabAdmin('tab-scan')" class="w-full text-left p-3 bg-white hover:bg-blue-50 rounded-xl shadow-sm font-semibold border-l-4 border-blue-600">ðŸ“‹ Laporan Scan</button>
                <button onclick="tabAdmin('tab-biaya')" class="w-full text-left p-3 bg-white hover:bg-blue-50 rounded-xl shadow-sm font-semibold border-l-4 border-green-600">ðŸ’° Laporan Biaya</button>
                <button onclick="location.reload()" class="w-full text-left p-3 bg-red-50 text-red-600 rounded-xl font-bold">Logout</button>
            </aside>

            <main class="flex-1 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-container">
                
                <div id="tab-scan" class="admin-content">
                    <div class="flex justify-between items-center mb-6 no-print">
                        <h3 class="text-xl font-bold">Laporan Scan Harian</h3>
                        <button onclick="window.print()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">Cetak PDF</button>
                    </div>
                    
                    <div class="report-header">
                        <h2 class="text-2xl font-bold">LAPORAN SCAN KANTIN</h2>
                        <p>Delta Spa & Health Club</p>
                        <hr class="my-4">
                    </div>

                    <div class="filter-area flex gap-2 mb-4 no-print">
                        <input type="date" id="tgl-scan" class="border p-2 rounded-lg text-sm">
                        <button onclick="muatLaporanScan()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Cari</button>
                    </div>

                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 border-b text-sm">JAM</th>
                                <th class="p-3 border-b text-sm">NAMA STAFF</th>
                                <th class="p-3 border-b text-sm">DIVISI</th>
                            </tr>
                        </thead>
                        <tbody id="body-scan"></tbody>
                    </table>
                </div>

                <div id="tab-biaya" class="admin-content hidden">
                    <div class="flex justify-between items-center mb-6 no-print">
                        <h3 class="text-xl font-bold">Detail Biaya & Klaim</h3>
                        <button onclick="window.print()" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm">Cetak PDF</button>
                    </div>

                    <div class="report-header">
                        <h2 class="text-2xl font-bold">REKAP BIAYA KANTIN</h2>
                        <p>Delta Spa & Health Club</p>
                        <hr class="my-4">
                    </div>

                    <div class="filter-area flex gap-2 mb-4 no-print">
                        <input type="date" id="tgl-biaya" class="border p-2 rounded-lg text-sm">
                        <button onclick="muatLaporanBiaya()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Hitung Biaya</button>
                    </div>

                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 border-b text-sm">NAMA STAFF</th>
                                <th class="p-3 border-b text-sm">STATUS</th>
                                <th class="p-3 border-b text-sm text-right">BIAYA</th>
                            </tr>
                        </thead>
                        <tbody id="body-biaya"></tbody>
                        <tfoot class="bg-blue-50 font-bold">
                            <tr>
                                <td colspan="2" class="p-3 text-right">TOTAL PENGELUARAN:</td>
                                <td id="total-seluruh-biaya" class="p-3 text-right text-blue-700">Rp 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

            </main>
        </div>
    </div>

    <script>
        // INISIALISASI SUPABASE
        const SB_URL = 'https://jfcppvzxqtuvlojhuftb.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmY3Bwdnp4cXR1dmxvamh1ZnRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzQ2NTIsImV4cCI6MjA4MTU1MDY1Mn0.L1uunUfLBaSkVzTDVQa0QlZEdBH0PyZprnZQ7I_pRj4';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // FUNGSI NAVIGASI
        function bukaAdmin() {
            const pass = prompt("Masukkan Password Admin:");
            if(pass === "kantin123") {
                document.getElementById('section-scan').classList.add('hidden');
                document.getElementById('section-admin').classList.remove('hidden');
            } else { alert("Akses Ditolak!"); }
        }

        function tabAdmin(id) {
            document.querySelectorAll('.admin-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // FUNGSI SCAN
        document.getElementById('input-nik').addEventListener('keypress', async (e) => {
            if(e.key === 'Enter') {
                const nik = e.target.value.trim();
                const status = document.getElementById('pesan-status');
                status.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

                const { data: staff } = await _supabase.from('staff').select('*').eq('nik', nik).maybeSingle();

                if(staff) {
                    const tgl = new Date().toLocaleDateString('en-CA');
                    const { data: cek } = await _supabase.from('laporan_makan').select('*').eq('nik_staff', nik).ilike('waktu', `%${tgl}%`);

                    if(cek.length > 0) {
                        status.innerText = "MAAF, ANDA SUDAH SCAN HARI INI";
                        status.className = "mt-6 p-4 rounded-xl font-bold bg-red-100 text-red-700";
                    } else {
                        await _supabase.from('laporan_makan').insert([{ nik_staff: staff.nik, nama_staff: staff.nama, divisi: staff.divisi }]);
                        status.innerText = "BERHASIL! SELAMAT MAKAN " + staff.nama;
                        status.className = "mt-6 p-4 rounded-xl font-bold bg-green-100 text-green-700";
                    }
                } else {
                    status.innerText = "NIK TIDAK TERDAFTAR!";
                    status.className = "mt-6 p-4 rounded-xl font-bold bg-red-100 text-red-700";
                }
                status.classList.remove('hidden');
                e.target.value = '';
                setTimeout(() => status.classList.add('hidden'), 3000);
            }
        });

        // FUNGSI LAPORAN
        async function muatLaporanScan() {
            const tgl = document.getElementById('tgl-scan').value;
            const { data } = await _supabase.from('laporan_makan').select('*').ilike('waktu', `%${tgl}%`).order('waktu', {ascending: false});
            
            let html = '';
            data.forEach(r => {
                const jam = new Date(r.waktu).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                html += `<tr class="border-b text-sm">
                    <td class="p-3">${jam}</td>
                    <td class="p-3 font-bold uppercase">${r.nama_staff}</td>
                    <td class="p-3 text-gray-500 uppercase">${r.divisi}</td>
                </tr>`;
            });
            document.getElementById('body-scan').innerHTML = html || '<tr><td colspan="3" class="p-4 text-center">Data kosong</td></tr>';
        }

        async function muatLaporanBiaya() {
            const tgl = document.getElementById('tgl-biaya').value;
            const { data: menu } = await _supabase.from('menu_harian').select('harga').eq('tanggal', tgl).maybeSingle();
            const harga = menu ? menu.harga : 0;

            const { data: staff } = await _supabase.from('staff').select('*').order('nama');
            const { data: klaim } = await _supabase.from('laporan_makan').select('nik_staff').ilike('waktu', `%${tgl}%`);

            let html = '';
            let total = 0;

            staff.forEach(s => {
                const isMakan = klaim.some(k => k.nik_staff === s.nik);
                const subTotal = isMakan ? harga : 0;
                total += subTotal;

                html += `<tr class="border-b text-sm">
                    <td class="p-3 uppercase font-semibold">${s.nama}</td>
                    <td class="p-3">${isMakan ? '<span class="text-green-600 font-bold">âœ… SUDAH</span>' : '<span class="text-gray-300">-</span>'}</td>
                    <td class="p-3 text-right">Rp ${subTotal.toLocaleString('id-ID')}</td>
                </tr>`;
            });
            document.getElementById('body-biaya').innerHTML = html;
            document.getElementById('total-seluruh-biaya').innerText = "Rp " + total.toLocaleString('id-ID');
        }

        // Set Tanggal Default
        const hariIni = new Date().toLocaleDateString('en-CA');
        document.getElementById('tgl-scan').value = hariIni;
        document.getElementById('tgl-biaya').value = hariIni;
    </script>
</body>
</html>
