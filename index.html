<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanti Delta Spa - Integrated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">

    <nav class="bg-white shadow-md p-4 flex justify-center gap-4">
        <button onclick="showPage('scan')" class="font-bold text-blue-600">SCAN ID</button>
        <button onclick="showPage('admin')" class="font-bold text-gray-500">ADMIN</button>
    </nav>

    <div id="page-scan" class="max-w-md mx-auto p-6">
        <div id="reader" class="rounded-lg overflow-hidden border-2 border-blue-500"></div>
        <input type="text" id="nik-input" placeholder="Atau ketik NIK Manual" class="w-full p-3 border rounded-lg mt-4">
        <button onclick="prosesMakan()" class="w-full bg-blue-600 text-white py-3 rounded-lg mt-2 font-bold">KLAIM JATAH MAKAN</button>
        <div id="status" class="mt-4 p-4 rounded-lg hidden text-center font-bold"></div>
    </div>

    <div id="page-admin" class="hidden max-w-md mx-auto p-6">
        <div class="bg-white p-4 rounded-xl shadow-md mb-6">
            <h2 class="font-bold mb-4">Tambah Staff</h2>
            <input type="text" id="add-nama" placeholder="Nama Staff" class="w-full p-2 border rounded mb-2">
            <input type="text" id="add-nik" placeholder="NIK" class="w-full p-2 border rounded mb-2">
            <button onclick="simpanStaff()" class="w-full bg-green-600 text-white py-2 rounded">Simpan ke Database</button>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-md">
            <h2 class="font-bold mb-4 text-sm">Laporan Makan Hari Ini</h2>
            <div id="log-list" class="text-xs space-y-2"></div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://jfcppvzxqtuvlojhuftb.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmY3Bwdnp4cXR1dmxvamh1ZnRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NzQ2NTIsImV4cCI6MjA4MTU1MDY1Mn0.L1uunUfLBaSkVzTDVQa0QlZEdBH0PyZprnZQ7I_pRj4';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showPage(p) {
            document.getElementById('page-scan').classList.toggle('hidden', p !== 'scan');
            document.getElementById('page-admin').classList.toggle('hidden', p !== 'admin');
            if(p === 'admin') muatLaporan();
        }

        // SIMPAN STAFF KE DATABASE
        async function simpanStaff() {
            const nama = document.getElementById('add-nama').value;
            const nik = document.getElementById('add-nik').value;
            const { error } = await supabase.from('staff').insert([{ nik, nama }]);
            if (error) alert("Gagal: " + error.message);
            else { alert("Staff Tersimpan!"); document.getElementById('add-nama').value=''; document.getElementById('add-nik').value=''; }
        }

        // PROSES MAKAN (SCAN/MANUAL)
        async function prosesMakan() {
            const nik = document.getElementById('nik-input').value;
            const statusBox = document.getElementById('status');
            
            // Cek apakah NIK terdaftar
            const { data: staff } = await supabase.from('staff').select('*').eq('nik', nik).single();

            if (staff) {
                // Simpan ke laporan_makan
                await supabase.from('laporan_makan').insert([{ nik_staff: nik, nama_staff: staff.nama }]);
                statusBox.innerHTML = "✅ Berhasil! Selamat Makan " + staff.nama;
                statusBox.className = "mt-4 p-4 rounded-lg bg-green-100 text-green-700 font-bold";
            } else {
                statusBox.innerHTML = "❌ NIK Tidak Ditemukan!";
                statusBox.className = "mt-4 p-4 rounded-lg bg-red-100 text-red-700 font-bold";
            }
            statusBox.classList.remove('hidden');
        }

        // AMBIL LAPORAN UNTUK ADMIN
        async function muatLaporan() {
            const { data } = await supabase.from('laporan_makan').select('*').order('waktu', { ascending: false });
            const list = document.getElementById('log-list');
            list.innerHTML = data.map(l => `<div class="border-b py-1 flex justify-between"><span>${l.nama_staff}</span><span>${new Date(l.waktu).toLocaleTimeString()}</span></div>`).join('');
        }

        // SCANNER QR
        const scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            document.getElementById('nik-input').value = txt;
            prosesMakan();
        });
    </script>
</body>
</html>
